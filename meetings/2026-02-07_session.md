# Session: 2026-02-07

## Summary
Implemented the auto-categorization system for predicting transaction categories on PDF upload.

## What We Built

### New Django App: `apps/categorization/`
A modular categorization service designed for LLM-based predictions now, with a path to ML model training later.

**Files Created:**
- `models.py` - `CategoryAssignment` model to track all category assignments (AI and user corrections) for future ML training
- `admin.py` - Admin interface for inspecting assignments
- `services/base.py` - Abstract `BaseCategorizer` interface with `CategoryPrediction` and `TransactionData` dataclasses
- `services/llm_categorizer.py` - OpenAI GPT-4o implementation that uses user's past corrections as few-shot examples

### Model Changes
- Added `user_confirmed` field to `Transaction` model to track when user has reviewed/changed AI suggestion

### Integration Points
1. **Statement Upload** (`apps/statements/views.py`):
   - After parsing PDF, calls `LLMCategorizer.categorize_batch()` with user's categories and history
   - Creates transactions with AI predictions (`ai_category_suggestion`, `ai_confidence`)
   - Records predictions in `CategoryAssignment` for training data

2. **Category Update** (`apps/transactions/views.py`):
   - Sets `user_confirmed=True` when user changes category
   - Records user corrections in `CategoryAssignment`

3. **UI** (`templates/transactions/list.html`):
   - Shows robot icon + confidence % badge for unconfirmed AI suggestions
   - Badge disappears after user confirms/changes category

## Technical Details

### LLMCategorizer Features
- Uses GPT-4o with low temperature (0.1) for consistent predictions
- Includes user's past categorization history as few-shot examples (up to 5 per category)
- Returns structured JSON with category name and confidence score
- Graceful fallback to "Other" if API unavailable

### CategoryAssignment Model
Tracks every assignment with:
- Source: `AI_PREDICTION`, `USER_CORRECTION`, or `USER_INITIAL`
- Denormalized transaction data for easy training export
- AI metadata (confidence, model version)

## Migrations Applied
- `transactions.0002_transaction_user_confirmed`
- `categorization.0001_initial`

## Dependencies Installed
- `dj-database-url`
- `django-htmx`

## Next Steps
- Test the system with a real PDF upload
- Monitor AI prediction accuracy
- Future: Export training data and build ML model

## Testing Results

### Server Started Successfully
- Installed missing dependencies: `whitenoise`, `django-htmx`, `dj-database-url`
- Server running on http://127.0.0.1:8000/

### Statement Upload Test
Tested with existing PDF statements:
- Wells Fargo statement: 3 transactions (payments/transfers) → All categorized as "Other" (70% confidence) - correct behavior
- SchoolFirst statement: 5 transactions (deposits/transfers) → All categorized as "Other" (90% confidence) - correct behavior

### Direct Categorizer Test (typical spending)
Tested LLMCategorizer with retail transactions:

| Transaction | Category | Confidence |
|-------------|----------|------------|
| TRADER JOES | Groceries | 95% |
| CHEVRON GAS STATION | Transportation | 90% |
| NETFLIX.COM | Entertainment | 95% |
| CHIPOTLE MEXICAN GRILL | Dining | 95% |
| AMAZON.COM | Shopping | 95% |
| UBER TRIP | Transportation | 95% |
| AT&T WIRELESS | Utilities | 95% |
| AMC THEATRES | Entertainment | 95% |

### Verification
- CategoryAssignment records being created correctly
- `user_confirmed=False` for new AI predictions
- AI confidence scores and suggestions stored on transactions

## Status
Implementation complete and tested. System working as expected.

---

# Part 2: Parser Revision

## Problem
The PDF parser was failing on various bank statement formats.

## Test Files Analyzed
- `Chase6292_Activity...CSV` - Chase credit card CSV export
- `20260107-statements-6292-.pdf` - Chase PDF statement (January 2026)
- `20260207-statements-6292-.pdf` - Chase PDF statement (February 2026)
- `072425 WellsFargo.pdf` - Wells Fargo checking statement
- `SchoolFirst_Account_Statement_January_2025.pdf` - Credit union statement
- `eStmt_2025-11-09.pdf` - Bank of America statement (Spanish)

## Changes Made

### `apps/statements/services/parser.py` - Complete Rewrite
- **Added CSV support**: New `_parse_csv()` method with Chase CSV format detection
- **Bank auto-detection**: Automatically detects bank from PDF content
- **Improved Chase PDF parsing**: Better regex patterns for `MM/DD MERCHANT CITY STATE AMOUNT` format
- **Added Wells Fargo parser**: Handles `M/D Description Amount Balance` format
- **Added Credit Union parser**: Handles SchoolFirst and similar formats
- **Improved Bank of America parser**: Handles Spanish statements
- **Extended dataclass**: Added `category_hint` and `transaction_type` fields to `ExtractedTransaction`
- **Better date parsing**: Handles multiple date formats
- **Improved skip detection**: More patterns to avoid headers/footers

### `apps/statements/forms.py`
- Updated to accept both PDF and CSV files (`.pdf,.csv`)

## Test Results

| File | Format | Transactions | Status |
|------|--------|--------------|--------|
| Chase CSV | CSV | 864 | Excellent |
| Chase PDF (Jan) | PDF | 133 | Excellent |
| Chase PDF (Feb) | PDF | 71 | Excellent |
| Wells Fargo | PDF | 3 | Good |
| SchoolFirst | PDF | 5 | Good |
| Bank of America | PDF | 2 | Limited (Spanish, zero balance) |

## Key Improvements
1. CSV support enables importing Chase transaction exports
2. Auto-detection means users don't need to select correct bank
3. Better regex patterns capture more transactions from PDFs
4. Fallback to OpenAI when regex fails

---

# Part 3: SchoolFirst Parser Fix

## Problem
The SchoolFirst credit union parser had issues:
1. Year was wrong (2026 instead of 2025) - wasn't extracting year from statement header
2. Missing merchant details for debit card transactions
3. "Balance Forward" and "Ending Balance" lines were being included as transactions

## Changes Made

### `apps/statements/services/parser.py`

**Fixed Credit Union Parser (`_parse_credit_union_pdf`):**
- Extract year from statement header `Date:01/01/25 - 01/31/25`
- Parse continuation lines for merchant details (e.g., `01/17 000027871099275721 5814 EVERYDAY 32566001 IRVINE CA`)
- Associate debit card transactions with their merchant details from continuation lines
- Line-by-line parsing instead of complex multi-line regex

**Added bank case for schoolfirst:**
- Added `elif self.bank in ('schoolfirst', 'credit_union')` case in `_parse_pdf`

**Improved skip detection:**
- Added patterns to skip: `balance forward`, `ending balance`, `joint owner`, `combined minimum`
- Changed from `re.match` to `re.search` to catch patterns anywhere in description

## Test Results

| Field | Before | After |
|-------|--------|-------|
| Transaction count | 5 | 5 (correct) |
| Year | 2026 (wrong) | 2025 (correct) |
| Debit Card merchant | "Withdrawal Debit Card" | "Withdrawal Debit Card - EVERYDAY IRVINE" |
| Balance Forward | Included | Skipped |
| Ending Balance | Included | Skipped |

## All Parsers Verified

| File | Format | Transactions | Status |
|------|--------|--------------|--------|
| Chase PDF (Jan) | PDF | 133 | Excellent |
| Chase PDF (Feb) | PDF | 71 | Excellent |
| Wells Fargo | PDF | 3 | Good |
| SchoolFirst | PDF | 5 | Fixed |
| Bank of America | PDF | 2 | Limited |

---

# Part 4: Secondary Categorization System

## Overview
Implemented a hybrid secondary categorization system supporting two budgeting frameworks:
1. **Wants vs Needs** - Simple 3-way classification: Need, Want, Savings
2. **Ramit Sethi's Conscious Spending Plan (CSP)** - 4 buckets with income-based targets

Both systems are opt-in per user, keeping the default experience simple.

## Architecture: Hybrid with Smart Defaults
- `BudgetCategory` has **default** spending type and CSP bucket
- `Transaction` has **override** fields (nullable) for exceptions
- Effective value = override if set, else category default
- User enables systems via profile settings

## Database Changes

### User Model (`apps/accounts/models.py`)
```python
monthly_income = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
enable_wants_needs = models.BooleanField(default=False)
enable_conscious_spending = models.BooleanField(default=False)
```

### BudgetCategory Model (`apps/budgets/models.py`)
```python
class SpendingType(models.TextChoices):
    NEED = 'need', 'Need'
    WANT = 'want', 'Want'
    SAVINGS = 'savings', 'Savings'

class CSPBucket(models.TextChoices):
    FIXED = 'fixed', 'Fixed Costs (50-60%)'
    INVESTMENTS = 'investments', 'Investments (10%+)'
    SAVINGS = 'savings', 'Savings Goals (5-15%+)'
    GUILT_FREE = 'guilt_free', 'Guilt-Free Spending (20-35%)'

default_spending_type = models.CharField(max_length=10, choices=SpendingType.choices, null=True, blank=True)
default_csp_bucket = models.CharField(max_length=15, choices=CSPBucket.choices, null=True, blank=True)
```

### Transaction Model (`apps/transactions/models.py`)
```python
spending_type_override = models.CharField(max_length=10, choices=SpendingType.choices, null=True, blank=True)
csp_bucket_override = models.CharField(max_length=15, choices=CSPBucket.choices, null=True, blank=True)

@property
def spending_type(self):
    return self.spending_type_override or (self.category.default_spending_type if self.category else None)

@property
def csp_bucket(self):
    return self.csp_bucket_override or (self.category.default_csp_bucket if self.category else None)
```

## Files Created

| File | Purpose |
|------|---------|
| `apps/accounts/forms.py` | ProfileSettingsForm for income and feature toggles |
| `apps/budgets/spending_analysis.py` | Helper functions for calculating breakdowns |
| `templates/transactions/partials/_spending_overrides.html` | HTMX dropdown for transaction overrides |

## Files Modified

| File | Changes |
|------|---------|
| `apps/accounts/models.py` | Added income, enable flags |
| `apps/accounts/views.py` | Form handling for profile settings |
| `apps/budgets/models.py` | Added enums, default fields, updated create_defaults_for_user |
| `apps/budgets/forms.py` | Added conditional dropdowns |
| `apps/budgets/views.py` | Pass user to category form |
| `apps/analytics/views.py` | Added spending summary to dashboard context |
| `apps/transactions/models.py` | Added override fields and properties |
| `apps/transactions/views.py` | Added update_spending_override endpoint |
| `apps/transactions/urls.py` | Added update-spending URL |
| `apps/categorization/services/base.py` | Extended CategoryPrediction dataclass |
| `apps/categorization/services/llm_categorizer.py` | Extended prompt for spending_type/csp_bucket |
| `templates/accounts/profile.html` | Added budgeting settings section |
| `templates/budgets/category_form.html` | Added conditional dropdowns |
| `templates/analytics/dashboard.html` | Added breakdown cards |
| `templates/transactions/detail.html` | Added spending classification section |

## Migrations Applied
- `accounts.0002_secondary_categorization`
- `budgets.0003_secondary_categorization`
- `budgets.0004_populate_category_defaults` (data migration)
- `transactions.0003_secondary_categorization`

## Default Category Mappings

| Category | Spending Type | CSP Bucket |
|----------|---------------|------------|
| Groceries | Need | Fixed Costs |
| Dining | Want | Guilt-Free |
| Transportation | Need | Fixed Costs |
| Entertainment | Want | Guilt-Free |
| Shopping | Want | Guilt-Free |
| Utilities | Need | Fixed Costs |
| Other | (none) | (none) |

## Test Results

| Test | Status |
|------|--------|
| Profile page loads | Pass |
| Budgeting Settings section renders | Pass |
| Monthly Income field present | Pass |
| Wants vs Needs toggle present | Pass |
| Conscious Spending toggle present | Pass |
| Settings save via POST | Pass |
| Dashboard shows Wants/Needs breakdown | Pass |
| Dashboard shows CSP breakdown | Pass |
| Category form shows spending type dropdown | Pass |
| Category form shows CSP bucket dropdown | Pass |
| Transaction detail shows spending overrides | Pass |
| Transaction spending override updates | Pass |

## UI Features

### Profile Settings (`/profile/`)
- Monthly income input field
- Toggle switches for Wants/Needs and CSP
- Info panel explaining CSP targets when enabled

### Category Form (`/budgets/create/`, `/budgets/<id>/edit/`)
- Default Spending Type dropdown (only if Wants/Needs enabled)
- Default CSP Bucket dropdown (only if CSP enabled)

### Dashboard (`/`)
**Wants vs Needs Card** (when enabled):
- Progress bars for Need, Want, Savings
- Color-coded by type

**Conscious Spending Plan Card** (when enabled):
- Progress bars for each bucket with target ranges
- Check/warning icons for on-target status
- Income comparison at bottom

### Transaction Detail (`/transactions/<id>/`)
- Spending Classification section (when features enabled)
- HTMX dropdowns for overriding spending type and CSP bucket
- Shows effective value and "(overridden)" indicator

## Commit
```
538fd19 Add secondary categorization system (Wants/Needs + Conscious Spending Plan)
```

## Status
Implementation complete and tested. All features working as expected.
