# Session: 2026-02-07

## Summary
Implemented the auto-categorization system for predicting transaction categories on PDF upload.

## What We Built

### New Django App: `apps/categorization/`
A modular categorization service designed for LLM-based predictions now, with a path to ML model training later.

**Files Created:**
- `models.py` - `CategoryAssignment` model to track all category assignments (AI and user corrections) for future ML training
- `admin.py` - Admin interface for inspecting assignments
- `services/base.py` - Abstract `BaseCategorizer` interface with `CategoryPrediction` and `TransactionData` dataclasses
- `services/llm_categorizer.py` - OpenAI GPT-4o implementation that uses user's past corrections as few-shot examples

### Model Changes
- Added `user_confirmed` field to `Transaction` model to track when user has reviewed/changed AI suggestion

### Integration Points
1. **Statement Upload** (`apps/statements/views.py`):
   - After parsing PDF, calls `LLMCategorizer.categorize_batch()` with user's categories and history
   - Creates transactions with AI predictions (`ai_category_suggestion`, `ai_confidence`)
   - Records predictions in `CategoryAssignment` for training data

2. **Category Update** (`apps/transactions/views.py`):
   - Sets `user_confirmed=True` when user changes category
   - Records user corrections in `CategoryAssignment`

3. **UI** (`templates/transactions/list.html`):
   - Shows robot icon + confidence % badge for unconfirmed AI suggestions
   - Badge disappears after user confirms/changes category

## Technical Details

### LLMCategorizer Features
- Uses GPT-4o with low temperature (0.1) for consistent predictions
- Includes user's past categorization history as few-shot examples (up to 5 per category)
- Returns structured JSON with category name and confidence score
- Graceful fallback to "Other" if API unavailable

### CategoryAssignment Model
Tracks every assignment with:
- Source: `AI_PREDICTION`, `USER_CORRECTION`, or `USER_INITIAL`
- Denormalized transaction data for easy training export
- AI metadata (confidence, model version)

## Migrations Applied
- `transactions.0002_transaction_user_confirmed`
- `categorization.0001_initial`

## Dependencies Installed
- `dj-database-url`
- `django-htmx`

## Next Steps
- Test the system with a real PDF upload
- Monitor AI prediction accuracy
- Future: Export training data and build ML model

## Testing Results

### Server Started Successfully
- Installed missing dependencies: `whitenoise`, `django-htmx`, `dj-database-url`
- Server running on http://127.0.0.1:8000/

### Statement Upload Test
Tested with existing PDF statements:
- Wells Fargo statement: 3 transactions (payments/transfers) → All categorized as "Other" (70% confidence) - correct behavior
- SchoolFirst statement: 5 transactions (deposits/transfers) → All categorized as "Other" (90% confidence) - correct behavior

### Direct Categorizer Test (typical spending)
Tested LLMCategorizer with retail transactions:

| Transaction | Category | Confidence |
|-------------|----------|------------|
| TRADER JOES | Groceries | 95% |
| CHEVRON GAS STATION | Transportation | 90% |
| NETFLIX.COM | Entertainment | 95% |
| CHIPOTLE MEXICAN GRILL | Dining | 95% |
| AMAZON.COM | Shopping | 95% |
| UBER TRIP | Transportation | 95% |
| AT&T WIRELESS | Utilities | 95% |
| AMC THEATRES | Entertainment | 95% |

### Verification
- CategoryAssignment records being created correctly
- `user_confirmed=False` for new AI predictions
- AI confidence scores and suggestions stored on transactions

## Status
Implementation complete and tested. System working as expected.

---

# Part 2: Parser Revision

## Problem
The PDF parser was failing on various bank statement formats.

## Test Files Analyzed
- `Chase6292_Activity...CSV` - Chase credit card CSV export
- `20260107-statements-6292-.pdf` - Chase PDF statement (January 2026)
- `20260207-statements-6292-.pdf` - Chase PDF statement (February 2026)
- `072425 WellsFargo.pdf` - Wells Fargo checking statement
- `SchoolFirst_Account_Statement_January_2025.pdf` - Credit union statement
- `eStmt_2025-11-09.pdf` - Bank of America statement (Spanish)

## Changes Made

### `apps/statements/services/parser.py` - Complete Rewrite
- **Added CSV support**: New `_parse_csv()` method with Chase CSV format detection
- **Bank auto-detection**: Automatically detects bank from PDF content
- **Improved Chase PDF parsing**: Better regex patterns for `MM/DD MERCHANT CITY STATE AMOUNT` format
- **Added Wells Fargo parser**: Handles `M/D Description Amount Balance` format
- **Added Credit Union parser**: Handles SchoolFirst and similar formats
- **Improved Bank of America parser**: Handles Spanish statements
- **Extended dataclass**: Added `category_hint` and `transaction_type` fields to `ExtractedTransaction`
- **Better date parsing**: Handles multiple date formats
- **Improved skip detection**: More patterns to avoid headers/footers

### `apps/statements/forms.py`
- Updated to accept both PDF and CSV files (`.pdf,.csv`)

## Test Results

| File | Format | Transactions | Status |
|------|--------|--------------|--------|
| Chase CSV | CSV | 864 | Excellent |
| Chase PDF (Jan) | PDF | 133 | Excellent |
| Chase PDF (Feb) | PDF | 71 | Excellent |
| Wells Fargo | PDF | 3 | Good |
| SchoolFirst | PDF | 5 | Good |
| Bank of America | PDF | 2 | Limited (Spanish, zero balance) |

## Key Improvements
1. CSV support enables importing Chase transaction exports
2. Auto-detection means users don't need to select correct bank
3. Better regex patterns capture more transactions from PDFs
4. Fallback to OpenAI when regex fails

---

# Part 3: SchoolFirst Parser Fix

## Problem
The SchoolFirst credit union parser had issues:
1. Year was wrong (2026 instead of 2025) - wasn't extracting year from statement header
2. Missing merchant details for debit card transactions
3. "Balance Forward" and "Ending Balance" lines were being included as transactions

## Changes Made

### `apps/statements/services/parser.py`

**Fixed Credit Union Parser (`_parse_credit_union_pdf`):**
- Extract year from statement header `Date:01/01/25 - 01/31/25`
- Parse continuation lines for merchant details (e.g., `01/17 000027871099275721 5814 EVERYDAY 32566001 IRVINE CA`)
- Associate debit card transactions with their merchant details from continuation lines
- Line-by-line parsing instead of complex multi-line regex

**Added bank case for schoolfirst:**
- Added `elif self.bank in ('schoolfirst', 'credit_union')` case in `_parse_pdf`

**Improved skip detection:**
- Added patterns to skip: `balance forward`, `ending balance`, `joint owner`, `combined minimum`
- Changed from `re.match` to `re.search` to catch patterns anywhere in description

## Test Results

| Field | Before | After |
|-------|--------|-------|
| Transaction count | 5 | 5 (correct) |
| Year | 2026 (wrong) | 2025 (correct) |
| Debit Card merchant | "Withdrawal Debit Card" | "Withdrawal Debit Card - EVERYDAY IRVINE" |
| Balance Forward | Included | Skipped |
| Ending Balance | Included | Skipped |

## All Parsers Verified

| File | Format | Transactions | Status |
|------|--------|--------------|--------|
| Chase PDF (Jan) | PDF | 133 | Excellent |
| Chase PDF (Feb) | PDF | 71 | Excellent |
| Wells Fargo | PDF | 3 | Good |
| SchoolFirst | PDF | 5 | Fixed |
| Bank of America | PDF | 2 | Limited |
